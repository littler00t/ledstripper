<html>
<head>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="pixi.js"></script>
<script type="text/javascript" src="codemirror.js"></script>
<script type="text/javascript" src="lua.js"></script>
<link rel="stylesheet" type="text/css" href="ledstrip.css" />
<link rel="stylesheet" href="codemirror.css">
<script type="text/javascript">

// global shared var with lua env
var led = null

$(document).ready(function(){
    var container = $('.ledstrip')[0];

    // create an new instance of a pixi stage
	var stage = new PIXI.Stage(0xFFFFFF, true);

	stage.setInteractive(false);

    var rwidth = 16;
    var rheight = 16;
    var rmarginx = 5;
    var rmarginy = 5;
    var marginleft = 10;
    var margintop = 10;
    var numperrow = 60;

    var numitems = 30;

	var canvasWidth = null;
	var canvasHeight = null;
	var renderer = null;

	function initCanvas() {
		console.log("initCanvas", numitems, numperrow, renderer == null);
		
	    canvasWidth = ((numperrow+1)*(rwidth+rmarginx));
	    canvasHeight = (Math.floor(numitems / numperrow)+1)*(rheight+rmarginy)+rmarginy*2;

		if(renderer == null) {
			renderer = PIXI.autoDetectRenderer(canvasWidth, canvasHeight);
		} else {
			renderer.resize(canvasWidth, canvasHeight);
		}

		renderer.view.style.width = canvasWidth + "px";
		renderer.view.style.height = canvasHeight + "px";

		// set the canvas width and height to fill the screen
		//renderer.view.style.width = window.innerWidth + "px";
		//renderer.view.style.height = window.innerHeight + "px";
		renderer.view.style.display = "block";

		// add render view to DOM
		container.appendChild(renderer.view);
	}
	
	var graphics = new PIXI.Graphics();

	function drawleds(frame) {
		
		var newframe = null;
		
		var numbytes = 0; 
		if(typeof frame == 'object' && frame.constructor === Array) {
			numbytes = frame.length;
			newframe = frame;
		} else {
			numbytes = numitems*3;
			newframe = Array(numbytes);
			// init to default value
			for(var i=0;i<numbytes;i++) {
				newframe[i] = 128;
			}
		}
		
	    graphics.clear();

	    for(var i=0;i<numitems;i++) {
	        var rownum = Math.floor(i / numperrow);
	        var topx = marginleft+(i % numperrow)*(rwidth+rmarginx);
	        var topy = margintop+rownum*(margintop+rheight);

	        graphics.lineStyle(1, 0x000000, 1);

			var bufferOffset = i*3;
			var color = (newframe[bufferOffset] << 16) | (newframe[bufferOffset+1] << 8) | (newframe[bufferOffset+2]);
	        graphics.beginFill(color, 1);
		    graphics.drawRect(topx, topy, rwidth, rheight);
		    graphics.endFill();
		}
	}
	
	// initial drawing
	initCanvas();
	drawleds();
	stage.addChild(graphics);
    renderer.render(stage);

	led = {
		latch: function(frame, numbytes, ial) {
			drawleds(frame);
			renderer.render(stage);
		},
		setsize: function(pnumitems, pnumperrow) {
			console.log("setsize", pnumitems, pnumperrow);
			numitems = pnumitems;
			if(typeof pnumperrow == 'number') {
				numperrow = pnumperrow;
			}
			initCanvas();
		},
		debug: function(a) {
			// TODO - restore functionality
			// var debugcontainer = $("<div>&nbsp;</div>")[0];
			// $("#debugcontainer").append(debugcontainer);
			// var debugstrip = LEDstrip(debugcontainer, numleds);
			// for(var i=1;i<=numleds;i++) {
			// 	var c = a.get(i);
			// 	if(typeof c == 'undefined') {
			// 		r = g = b = 0;
			// 	} else {
			// 		r = c.get(1);
			// 		g = c.get(2);
			// 		b = c.get(3);
			// 	}
			// 	debugstrip.pushrgb([r,g,b]);
			// }
			// debugstrip.latch();
		}
	}

	$('#diffuser').change(function(e) {
		$('.ledstrip').toggleClass('diffuse');
	});

});
</script>
</head>
<body>
       <header>
         <h1>LED Strip Simulator</h1>
       </header>
       <article>
         <div class="ledstrip"></div>
         <br />
         <form>
           <input type="checkbox" id="diffuser" value="0" /> <label for="diffuser">Diffuser</label>
         </form>
         <br/>
         <p>
           <button onclick="executeLua(myCodeMirror.getValue(), true); return false" id="execute">Execute</button>
           <button onclick="led.stopled()" id="stop">Stop</button>
         </p>
         <p>
         <textarea id="mytext">
-- This is lua!
print("this will go to console")
-- number of LEDs
-- param1: number of LEDs
-- param2: break after count (optional)
-- e.g. setstripsize(30,10) - show 3 rows with 10 elements each
setstripsize(30)
-- fps
setframerate(60)

-- define a init function 'init_animation' that takes the number of leds
-- define a function with the signature of 'frame' that returns frames (char sequence of byte color values)
-- call the startled function passing in the frame function to start simulator. init_animation will get called then.

---- scanner example
led_count = 0
function init_animation(_led_count)
    print("init animation called. num leds: " .. _led_count)
    led_count = _led_count
    color = {0,255,0}
    spread = 3
    direction = 1
    position = 1
    
    dot = ""
    for i = spread,1 do
        r = math.floor(color[1] * ((spread + 1 - i) / (spread + 1)))
        g = math.floor(color[2] * ((spread + 1 - i) / (spread + 1)))
        b = math.floor(color[3] * ((spread + 1 - i) / (spread + 1)))
        dot = dot .. string.char(r, g, b)
    end
    dot = string.char(color[1], color[2], color[3])
    for i = 1,spread do
        r = math.floor(color[1] * ((spread + 1 - i) / (spread + 1)))
        g = math.floor(color[2] * ((spread + 1 - i) / (spread + 1)))
        b = math.floor(color[3] * ((spread + 1 - i) / (spread + 1)))
        dot = dot .. string.char(r, g, b)
    end
    dotwidth = (2 * spread) + 1
end

function scanner()
    startofdot = position - spread
    buffer = string.char(0, 0, 0):rep(startofdot)
    
    position = position + direction;
    
    if (position > led_count) then
        position = position - 2
        direction = -1
    end
    
    if (position < 1) then
        position = position + 2
        direction = 1
    end
    
    buffer = buffer .. dot
    
    buffer = buffer .. string.char(0, 0, 0):rep(led_count - (startofdot + dotwidth))
    return buffer
end
---- end of scanner example

-- frame function gets called with frameCounter 
function frame(frameCounter)
    -- print("frame #" .. frameCounter)
    return scanner()
end

-- start the animation
startled(frame)
         </textarea>
         <p>
           <h4>output</h4>
           <div id="debugcontainer"></div>
           <pre id="output"></pre>
         </p>
    </p>
    </article>

<script type="text/lua">
    -- frame rate (fps)
    framerate = 60
    function pushled (a)
        actualnumbytes = string.len(a)
        intarray = {n=actualnumbytes}
        for i=1, actualnumbytes do
            intarray[i] = string.byte(a, i)
            --print("i" .. "i" .. ", a:" .. string.byte(a, i) .. ", intarray:" .. intarray[i])
        end
        intarraylen = #intarray
        js.global.led:latch(js.global:Array(table.unpack(intarray)), actualnumbytes, intarraylen)
        -- print("frame #" .. pushledFrameCount .. ", bytes:" .. actualnumbytes)
        pushledFrameCount = pushledFrameCount + 1
    end
    function bytestostring(bytes)
      s = {}
      cnt = 1
      for i = 1, #bytes do
        for j = 1, 3 do
          s[cnt] = string.char(bytes[i][j])
          cnt = cnt +1
        end
      end
      return table.concat(s)
    end
    cnt = 0
    function stopled()
        window:clearInterval(js.global.led.interval)
    end
    js.global.led.stopled = stopled
    function startled(framegen)
        pushledFrameCount = 0
        delay = 1000/framerate
        stopled()
        init_animation(getstripsize())
        js.global.led.interval = window:setInterval(function() pushled(framegen(pushledFrameCount)) end, delay)
    end
    function setstripsize(pnumleds, pbreakat)
        numleds = pnumleds
        breakat = pbreakat
        js.global.led:setsize(pnumleds, pbreakat)
    end
    function getstripsize()
        return numleds
    end
    -- needs to be set before startled
    function setframerate(newframerate)
        framerate = newframerate
    end
    function debugframe(frame)
        js.global.led:debug(frame)
    end
        
</script>

<script>
    // CodeMirror
    var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('mytext'));
    //myCodeMirror.setSize(screen.width*0.6, screen.height*0.2);
    
    // Execution
    var outputElement = document.getElementById('output')
    var Module = {
      print: function(x) {
        outputElement.textContent = (outputElement.textContent ? outputElement.textContent + '\n' : '') + x;
      }
    };
    
    function executeLua(code, clear) {
      if (clear) {
        outputElement.style.color = null;
        outputElement.textContent = '';
      }
      try {
        L.execute(code);
      } catch(e) {
        outputElement.style.color = "red";
        outputElement.textContent = e.toString();
      }
    }
</script>
<script src="lua.vm.js"></script>
</body>
</html>
